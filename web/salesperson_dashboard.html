<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SAMS | Salesperson Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<style>
:root {
  --primary:#5e3505; --secondary:#ffd54f; --accent:#EF476F;
  --bg:#f7f7f7; --radius:10px; --shadow:0 6px 16px rgba(0,0,0,.1);
}

*{box-sizing:border-box;}

body {
  font-family:"Poppins",sans-serif;
  background:var(--bg);
  margin:0;
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* ===== Sidebar ===== */
.sidebar {
  width:250px;
  background:var(--primary);
  color:white;
  padding:1rem 0;
  display:flex;
  flex-direction:column;
  align-items:center;
  box-shadow:var(--shadow);
}

.sidebar h2 {
  color:var(--secondary);
  margin-bottom:2rem;
}

.sidebar a {
  display:flex;
  align-items:center;
  gap:10px;
  width:80%;
  padding:0.7rem 1rem;
  margin:0.3rem 0;
  color:white;
  text-decoration:none;
  border-radius:var(--radius);
  transition:all .3s ease;
}

.sidebar a:hover,
.sidebar a.active {
  background:var(--secondary);
  color:var(--primary);
}

/* ===== Main Content ===== */
.main {
  flex:1;
  overflow-y:auto;
  padding:2rem;
}

section {
  background:white;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:1.5rem;
  margin-bottom:2rem;
  display:none;
}

section.active {
  display:block;
}

section h2 {
  color:var(--primary);
  border-bottom:2px solid var(--secondary);
  padding-bottom:0.5rem;
  margin-top:0;
  display:flex;
  align-items:center;
  gap:0.5rem;
}

/* ===== Cards ===== */
.card-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(230px,1fr));
  gap:1.5rem;
}

.card {
  background:white;
  padding:1.2rem;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  text-align:center;
}

.card h2 { font-size:2rem; color:var(--primary); }
.card p { color:#444; margin-top:0.5rem; }

/* ===== Tables ===== */
table {
  width:100%;
  border-collapse:collapse;
  background:white;
  box-shadow:var(--shadow);
  border-radius:var(--radius);
  overflow:hidden;
  margin-top:1rem;
}

th,td {
  padding:0.8rem 1rem;
  border-bottom:1px solid #eee;
}

th {
  background:var(--primary);
  color:white;
  text-align:left;
}

tr:hover { background:#f9f9f9; }

/* ===== Buttons ===== */
button {
  padding:0.5rem 0.8rem;
  border:none;
  border-radius:var(--radius);
  cursor:pointer;
  font-weight:600;
  transition:all .3s ease;
}

.confirmBtn {
  background:#06d6a0;
  color:white;
  margin-right:5px;
}

.rejectBtn {
  background:#EF476F;
  color:white;
}

.refundedBtn {
  background:var(--accent);
  color:white;
}

button:hover {
  opacity:0.9;
  transform:translateY(-1px);
}

/* Align Accept & Reject side-by-side */
td:last-child {
  display:flex;
  justify-content:center;
  gap:10px;
}

/* Logout Button */
.logoutBtn {
  background:var(--secondary);
  color:var(--primary);
  margin-top:1.5rem;
  padding:0.6rem 1.2rem;
  border-radius:var(--radius);
  font-weight:600;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:8px;
  box-shadow:var(--shadow);
  transition:all .3s ease;
  text-decoration:none;
  width:80%;
  justify-content:center;
}
.logoutBtn:hover { transform:translateY(-2px); opacity:0.9; }
.logoutBtn i { font-size:1.2rem; }
</style>
</head>
<body>

<!-- ===== SIDEBAR ===== -->
<div class="sidebar">
  <h2>üßæ SAMS</h2>
  <a href="#" class="nav-link active" data-section="overview"><i class='bx bx-bar-chart'></i> Overview</a>
  <a href="#" class="nav-link" data-section="refunds"><i class='bx bx-money'></i> Refunds</a>
  <a href="#" class="nav-link" data-section="bookings"><i class='bx bx-chair'></i> Bookings</a>
  <a href="#" class="nav-link" data-section="confirmations"><i class='bx bx-time'></i> Confirmations</a>

  <!-- ‚úÖ Added Logout Button in Sidebar -->
  <button class="logoutBtn" onclick="logout()"><i class='bx bx-log-out'></i> Logout</button>
</div>

<!-- ===== MAIN CONTENT ===== -->
<div class="main">
  <h1>üéüÔ∏è Salesperson Dashboard</h1>

  <!-- Overview -->
  <section id="overview" class="active">
    <h2><i class='bx bx-bar-chart'></i> Dashboard Overview</h2>
    <div class="card-grid">
      <div class="card"><h2 id="refundedCount">0</h2><p>Seats Cancelled & Refunded</p></div>
      <div class="card"><h2 id="cancelledCount">0</h2><p>Seats Cancelled (Not Refunded)</p></div>
      <div class="card"><h2 id="unbookedCount">0</h2><p>Unbooked Seats</p></div>
      <div class="card"><h2 id="totalBooked">0</h2><p>Total Booked Seats</p></div>
    </div>
  </section>

  <!-- Refunds -->
  <section id="refunds">
    <h2><i class='bx bx-money'></i> Pending Refunds</h2>
    <table id="pendingRefundsTable">
      <thead>
        <tr>
          <th>Booking ID</th>
          <th>Event</th>
          <th>Seat Numbers</th>
          <th>User</th>
          <th>Refund Amount</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Bookings -->
  <section id="bookings">
    <h2><i class='bx bx-chair'></i> Booked Seat Details</h2>
    <table id="bookedSeatsTable">
      <thead>
        <tr>
          <th>Booking ID</th>
          <th>Event</th>
          <th>Seat Numbers</th>
          <th>User</th>
          <th>Amount</th>
          <th>Created</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Confirmations -->
  <section id="confirmations">
    <h2><i class='bx bx-time'></i> Pending Confirmations (PAID)</h2>
    <table id="pendingConfirmationsTable">
      <thead>
        <tr>
          <th>Reservation ID</th>
          <th>Event</th>
          <th>Seats</th>
          <th>User</th>
          <th>Amount</th>
          <th>Created</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<script>
/* ===== Sidebar Navigation ===== */
document.querySelectorAll(".nav-link").forEach(link=>{
  link.addEventListener("click",()=>{
    document.querySelectorAll(".nav-link").forEach(a=>a.classList.remove("active"));
    link.classList.add("active");
    const sectionId = link.dataset.section;
    document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
    document.getElementById(sectionId).classList.add("active");
  });
});

/* ===== Logout ===== */
function logout(){
  if(confirm("Are you sure you want to logout?")){
    window.location.href = "login_signup.html";
  }
}

/* ===== Fetch Data from Servlet ===== */
async function fetchData() {
  let refundRes = await fetch('BookingServlet?action=listRefunds');
  let refunds = await refundRes.json();
  const refundTbody = document.querySelector("#pendingRefundsTable tbody");
  refundTbody.innerHTML = "";
  refunds.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.id}</td>
                    <td>${r.event}</td>
                    <td>${r.seats}</td>
                    <td>${r.user}</td>
                    <td>${r.refundAmount}</td>
                    <td>${r.status==='CANCELLED' ?
                      `<button class='refundedBtn' data-id='${r.id}'>Mark Refunded</button>` : 'Already Refunded'}</td>`;
    refundTbody.appendChild(tr);
  });

  let bookedRes = await fetch('BookingServlet?action=listBooked');
  let booked = await bookedRes.json();
  const bookedTbody = document.querySelector("#bookedSeatsTable tbody");
  bookedTbody.innerHTML = "";
  booked.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.id}</td>
                    <td>${r.event}</td>
                    <td>${r.seats}</td>
                    <td>${r.user}</td>
                    <td>${r.total}</td>
                    <td>${r.created_at}</td>`;
    bookedTbody.appendChild(tr);
  });

  let paidRes = await fetch('BookingServlet?action=listPaid');
  let paid = await paidRes.json();
  const pendingTbody = document.querySelector("#pendingConfirmationsTable tbody");
  pendingTbody.innerHTML = "";
  paid.forEach(r => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${r.id}</td>
                    <td>${r.event}</td>
                    <td>${r.seats}</td>
                    <td>${r.user}</td>
                    <td>${r.total}</td>
                    <td>${r.created_at}</td>
                    <td>
                      <button class='confirmBtn' data-id='${r.id}'>Accept</button>
                      <button class='rejectBtn' data-id='${r.id}'>Reject</button>
                    </td>`;
    pendingTbody.appendChild(tr);
  });

  updateCounts(refunds, booked);
  attachActions();
}

function updateCounts(refunds, booked){
  document.getElementById("refundedCount").textContent = refunds.filter(r=>r.status==='REFUNDED').length;
  document.getElementById("cancelledCount").textContent = refunds.filter(r=>r.status==='CANCELLED').length;
  const totalSeats = booked.reduce((sum,r)=>sum + (r.seats.split(",").length),0);
  document.getElementById("totalBooked").textContent = totalSeats;
  document.getElementById("unbookedCount").textContent = 50;
}

function attachActions(){
  document.querySelectorAll(".refundedBtn").forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm("Mark as refunded?")) return;
      let res = await fetch("BookingServlet",{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:`action=markRefunded&reservationId=${btn.dataset.id}`
      });
      let j = await res.json();
      if(j.status==="success") fetchData();
      else alert("Failed");
    };
  });

  document.querySelectorAll(".confirmBtn").forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm("Confirm this reservation?")) return;
      let res = await fetch("BookingServlet",{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:`action=confirm&reservationId=${btn.dataset.id}`
      });
      let j = await res.json();
      if(j.status==="success") fetchData();
      else alert("Failed");
    };
  });

  document.querySelectorAll(".rejectBtn").forEach(btn=>{
    btn.onclick = async ()=>{
      if(!confirm("Reject this reservation?")) return;
      let res = await fetch("BookingServlet",{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:`action=cancel&reservationId=${btn.dataset.id}`
      });
      let j = await res.json();
      if(j.status==="success") fetchData();
      else alert("Failed");
    };
  });
}

fetchData();
setInterval(fetchData,10000);
</script>
</body>
</html>
